<script>
// === CONFIG ===
  var WORKER_URL = "https://seocho-aqi.lionel-zannier.workers.dev"; // <-- remplace ici
  var LAT = 37.4836;
  var LON = 127.0327;

  // Rafraîchissement 15 minutes
  var REFRESH_SECONDS = 900;
  var remaining = REFRESH_SECONDS;

  function setText(id, txt) {
    document.getElementById(id).textContent = txt;
  }

  function polLabel(code) {
    if (!code) return "--";
    if (code === "pm25") return "PM2.5";
    if (code === "pm10") return "PM10";
    if (code === "o3") return "O₃";
    if (code === "no2") return "NO₂";
    if (code === "so2") return "SO₂";
    return code.toUpperCase();
  }

  async function fetchAQI() {
    remaining = REFRESH_SECONDS;

    var url = WORKER_URL
      + "?lat=" + encodeURIComponent(LAT)
      + "&lon=" + encodeURIComponent(LON)
      + "&_t=" + Date.now();

    try {
      var res = await fetch(url, { cache: "reload" });
      var json = await res.json();

      if (json.status !== "ok") {
        setText("updated", "Erreur données WAQI");
        return;
      }

      var d = json.data;

      setText("aqi", d.aqi);
      setText("main", "Polluant : " + polLabel(d.dominentpol));
      setText("pm25", "PM2.5 : " + (d.iaqi.pm25 ? d.iaqi.pm25.v + " µg/m³" : "--"));
      setText("station", "Station : " + d.city.name);
      setText("updated", "Mesure : " + d.time.iso.replace("T"," ").slice(0,16));

    } catch (e) {
      setText("updated", "Erreur réseau");
    }
  }

  // Compteur visible
  setInterval(function () {
    remaining--;
    if (remaining < 0) remaining = REFRESH_SECONDS;
    setText("countdown", "Prochaine mise à jour dans " + Math.ceil(remaining / 60) + " min");
  }, 1000);

  fetchAQI();
  setInterval(fetchAQI, REFRESH_SECONDS * 1000);
</script>
